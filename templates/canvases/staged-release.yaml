metadata:
  name: "Staged Release"
  description: "Gradually roll out releases through 10%, 50%, and 100% stages with health checks at each step."
  isTemplate: false
spec:
  nodes:
    - id: "github-onrelease-github-onrelease-a005gl"
      name: "Listen to new Releases"
      type: "TYPE_TRIGGER"
      configuration:
        actions:
          - "published"
        customName: null
        repository: "infrastructure"
      metadata:
        repository:
          id: 1059284161
          name: "infrastructure"
          url: "https://github.com/puppies-inc/infrastructure"
      position:
        x: 133
        "y": 403
      component: null
      blueprint: null
      trigger:
        name: "github.onRelease"
      widget: null
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "component-node-70p83y"
      name: "Wait for the changes to propagate"
      type: "TYPE_COMPONENT"
      configuration:
        mode: "interval"
        unit: "minutes"
        waitFor: "10"
      metadata: null
      position:
        x: 1191
        "y": 402
      component:
        name: "wait"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "component-node-7z3mea"
      name: "Slack: Deployment failed"
      type: "TYPE_COMPONENT"
      configuration:
        channel: "C09AJT3BF1Q"
        text: "Deployment of the {{$['Listen to new Releases'].data.release.name}} has failed. \n\nCheck the workflow for details: {{$['Deploy 10%'].data.workflow_run.html_url}}"
      metadata:
        channel:
          id: "C09AJT3BF1Q"
          name: "all-efod-test-org"
      position:
        x: 1195
        "y": 636
      component:
        name: "slack.sendTextMessage"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: true
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "component-node-1krig8"
      name: "Check if there are any alerts 10%"
      type: "TYPE_COMPONENT"
      configuration: {}
      metadata:
        checkRules:
          - id: "0310867c-4c22-49dd-8987-9995eda6ba7c"
            name: "HTTP response time"
          - id: "7c09c551-88f2-4c9d-b7e3-6fb05655b0fd"
            name: "5xx check"
          - id: "acc0f539-efe6-4507-904d-5ab40d0517fb"
            name: "4xx check"
      position:
        x: 1712
        "y": 221
      component:
        name: "dash0.listIssues"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "component-node-3c9afc"
      name: "Health Check: Ping server 10%"
      type: "TYPE_COMPONENT"
      configuration:
        method: "POST"
        retries: 3
        timeoutSeconds: 10
        timeoutStrategy: "exponential"
        url: "https://url.to-your.server/check"
      metadata: null
      position:
        x: 1715
        "y": 402
      component:
        name: "http"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "merge-merge-vckyv1"
      name: "Wait for all the checks to finish"
      type: "TYPE_COMPONENT"
      configuration:
        enableStopIf: true
        enableTimeout: true
        executionTimeout:
          unit: "minutes"
          value: 2
        stopIfExpression: "$['Check if there are open issues 10%'].data.total>0 || $[\"Health Check: Ping server 10%\"].data.body.healthy == false || $[\"Check if there are any alerts 10%\"].data.status !=\"clear\""
      metadata: null
      position:
        x: 2295
        "y": 405
      component:
        name: "merge"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "dash0-listissues-check-if-there-are-any-alerts-pbjufl"
      name: "Check if there are any alerts 50%"
      type: "TYPE_COMPONENT"
      configuration: {}
      metadata:
        checkRules:
          - id: "0310867c-4c22-49dd-8987-9995eda6ba7c"
            name: "HTTP response time"
          - id: "7c09c551-88f2-4c9d-b7e3-6fb05655b0fd"
            name: "5xx check"
          - id: "acc0f539-efe6-4507-904d-5ab40d0517fb"
            name: "4xx check"
      position:
        x: 4026
        "y": 408
      component:
        name: "dash0.listIssues"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: true
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "http-health-check--ping-server-spb8ma"
      name: "Health Check: Ping server 50%"
      type: "TYPE_COMPONENT"
      configuration:
        method: "POST"
        retries: 3
        timeoutSeconds: 10
        timeoutStrategy: "exponential"
        url: "https://url.to-your.server/check"
      metadata: null
      position:
        x: 4028
        "y": 480
      component:
        name: "http"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: true
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "wait-wait-for-the-changes-to-propagate-9f6hct"
      name: "Wait for the changes to propagate 50%"
      type: "TYPE_COMPONENT"
      configuration:
        mode: "interval"
        unit: "minutes"
        waitFor: "10"
      metadata: null
      position:
        x: 3480
        "y": 405
      component:
        name: "wait"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "merge-merge-as9s0i"
      name: "Wait for all the checks to finish - final"
      type: "TYPE_COMPONENT"
      configuration:
        enableStopIf: true
        enableTimeout: true
        executionTimeout:
          unit: "minutes"
          value: 2
        stopIfExpression: "$['Check if there are open issues 50%'].data.total>0 || $[\"Health Check: Ping server 50%\"].data.body.healthy == false || $[\"Check if there are any alerts 50%\"].data.status !=\"clear\""
      metadata: null
      position:
        x: 4565
        "y": 479
      component:
        name: "merge"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: true
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "pagerduty-listincidents-pagerduty-listincidents-kcozn1"
      name: "Check if there are open issues 10%"
      type: "TYPE_COMPONENT"
      configuration: {}
      metadata:
        services: null
      position:
        x: 1719
        "y": 644
      component:
        name: "pagerduty.listIncidents"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "github-runworkflow-github-runworkflow-t0ed50"
      name: "Deploy 10%"
      type: "TYPE_COMPONENT"
      configuration:
        inputs:
          - name: "environment"
            value: "production"
          - name: "percentage"
            value: "10"
        ref: "main"
        repository: "puppy-describer"
        workflowFile: ".github/workflows/deploy.yml"
      metadata:
        repository:
          id: 1046188046
          name: "puppy-describer"
          url: "https://github.com/puppies-inc/puppy-describer"
      position:
        x: 634
        "y": 402
      component:
        name: "github.runWorkflow"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "github-runworkflow-deploy-10--w3pcg4"
      name: "Deploy 50%"
      type: "TYPE_COMPONENT"
      configuration:
        inputs:
          - name: "environment"
            value: "production"
          - name: "percentage"
            value: "50"
        ref: "main"
        repository: "puppy-describer"
        workflowFile: ".github/workflows/deploy.yml"
      metadata:
        repository:
          id: 1046188046
          name: "puppy-describer"
          url: "https://github.com/puppies-inc/puppy-describer"
      position:
        x: 2865
        "y": 411
      component:
        name: "github.runWorkflow"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "pagerduty-listincidents-check-if-there-are-open-issues-jl7aze"
      name: "Check if there are open issues  50%"
      type: "TYPE_COMPONENT"
      configuration: {}
      metadata:
        services: null
      position:
        x: 4028
        "y": 555
      component:
        name: "pagerduty.listIncidents"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: true
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "annotation-annotation-dsxtwd"
      name: "annotation"
      type: "TYPE_WIDGET"
      configuration:
        color: "yellow"
        height: 300
        text: "## GitHub release trigger\n\nThis node listens for new releases published in your repository and starts the staged rollout process.\n\n\n### To set up\n1. Click the node to open the sidebar configuration.\n2. Follow the instructions to connect your GitHub account.\n3. Once connected, select the repository to monitor for releases."
        width: 371
      metadata: null
      position:
        x: 126
        "y": -7
      component: null
      blueprint: null
      trigger: null
      widget:
        name: "annotation"
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "annotation-annotation2-xt7sds"
      name: "annotation2"
      type: "TYPE_WIDGET"
      configuration:
        color: "yellow"
        height: 257
        text: "### Staged deployment\n\nThe **GitHub Run Workflow** component triggers a deployment workflow with two parameters exported as environment variables:\n- **environment**: the target environment (e.g., production)\n- **percentage**: the percentage of servers to deploy to\n\nIf the deployment succeeds, the Canvas waits for changes to propagate before running health checks.  \nIf it fails, a Slack message is sent immediately.\n\nThe **Slack message** uses event data from upstream components.  \nOpen the node sidebar to explore how payload data is referenced."
        width: 929
      metadata: null
      position:
        x: 619
        "y": 59
      component: null
      blueprint: null
      trigger: null
      widget:
        name: "annotation"
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "annotation-annotation3-e3jalx"
      name: "annotation3"
      type: "TYPE_WIDGET"
      configuration:
        color: "yellow"
        height: 336
        text: "### Health checks\n\nThree different checks run in parallel to verify system health:\n\n**Dash0 List Issues**: Queries your Dash0 instance for failing check rules. You need to have check rules configured in Dash0.\n\n**HTTP Health Check**: Pings a custom endpoint to verify the application is up and responding correctly.\n\n**PagerDuty List Incidents**: Checks if there are any open incidents that might indicate problems with the deployment."
        width: 365
      metadata: null
      position:
        x: 1707
        "y": -173
      component: null
      blueprint: null
      trigger: null
      widget:
        name: "annotation"
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "annotation-annotation4-55btsm"
      name: "annotation4"
      type: "TYPE_WIDGET"
      configuration:
        color: "yellow"
        height: 319
        text: "### Merge and conditional stop\n\nThe **Merge** component waits for all health checks to complete before proceeding.\n\nIt has two important configurations:\n- **Timeout**: Limits how long to wait for all checks\n- **Conditional Stop**: Stops the workflow immediately if any check fails\n\nOpen the node sidebar to see the stop condition expression.  \n\nConsider adding a notification component to alert your team if health checks fail or timeout."
        width: 382
      metadata: null
      position:
        x: 2289
        "y": -31
      component: null
      blueprint: null
      trigger: null
      widget:
        name: "annotation"
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "github-runworkflow-github-runworkflow-0ae6uu"
      name: "Deploy 100%"
      type: "TYPE_COMPONENT"
      configuration:
        inputs:
          - name: "environment"
            value: "production"
          - name: "percentage"
            value: "100"
        ref: "main"
        repository: "puppy-describer"
        workflowFile: ".github/workflows/deploy.yml"
      metadata:
        repository:
          id: 1046188046
          name: "puppy-describer"
          url: "https://github.com/puppies-inc/puppy-describer"
      position:
        x: 5121
        "y": 399
      component:
        name: "github.runWorkflow"
      blueprint: null
      trigger: null
      widget: null
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
    - id: "annotation-annotation5-0fn8v7"
      name: "annotation5"
      type: "TYPE_WIDGET"
      configuration:
        color: "yellow"
        height: 193
        text: "### Staged rollout progression\n\nThis Canvas repeats the deploy-and-verify cycle for **10%**, **50%**, and finally **100%** of servers.\n\nEach stage runs the same health checks before proceeding to the next.\n\nNodes can be collapsed or expanded to reduce visual clutter.  \nHover on any node to toggle its collapsed view from hover menu."
        width: 493
      metadata: null
      position:
        x: 2859
        "y": -21
      component: null
      blueprint: null
      trigger: null
      widget:
        name: "annotation"
      isCollapsed: false
      integration: null
      errorMessage: ""
      warningMessage: ""
  edges:
    - sourceId: "component-node-70p83y"
      targetId: "component-node-1krig8"
      channel: "default"
    - sourceId: "component-node-70p83y"
      targetId: "component-node-3c9afc"
      channel: "default"
    - sourceId: "component-node-3c9afc"
      targetId: "merge-merge-vckyv1"
      channel: "default"
    - sourceId: "component-node-1krig8"
      targetId: "merge-merge-vckyv1"
      channel: "critical"
    - sourceId: "component-node-1krig8"
      targetId: "merge-merge-vckyv1"
      channel: "degraded"
    - sourceId: "component-node-1krig8"
      targetId: "merge-merge-vckyv1"
      channel: "clear"
    - sourceId: "wait-wait-for-the-changes-to-propagate-9f6hct"
      targetId: "dash0-listissues-check-if-there-are-any-alerts-pbjufl"
      channel: "default"
    - sourceId: "wait-wait-for-the-changes-to-propagate-9f6hct"
      targetId: "http-health-check--ping-server-spb8ma"
      channel: "default"
    - sourceId: "dash0-listissues-check-if-there-are-any-alerts-pbjufl"
      targetId: "merge-merge-as9s0i"
      channel: "clear"
    - sourceId: "dash0-listissues-check-if-there-are-any-alerts-pbjufl"
      targetId: "merge-merge-as9s0i"
      channel: "degraded"
    - sourceId: "dash0-listissues-check-if-there-are-any-alerts-pbjufl"
      targetId: "merge-merge-as9s0i"
      channel: "critical"
    - sourceId: "http-health-check--ping-server-spb8ma"
      targetId: "merge-merge-as9s0i"
      channel: "default"
    - sourceId: "component-node-70p83y"
      targetId: "pagerduty-listincidents-pagerduty-listincidents-kcozn1"
      channel: "default"
    - sourceId: "pagerduty-listincidents-pagerduty-listincidents-kcozn1"
      targetId: "merge-merge-vckyv1"
      channel: "clear"
    - sourceId: "pagerduty-listincidents-pagerduty-listincidents-kcozn1"
      targetId: "merge-merge-vckyv1"
      channel: "low"
    - sourceId: "pagerduty-listincidents-pagerduty-listincidents-kcozn1"
      targetId: "merge-merge-vckyv1"
      channel: "high"
    - sourceId: "github-onrelease-github-onrelease-a005gl"
      targetId: "github-runworkflow-github-runworkflow-t0ed50"
      channel: "default"
    - sourceId: "github-runworkflow-github-runworkflow-t0ed50"
      targetId: "component-node-70p83y"
      channel: "passed"
    - sourceId: "github-runworkflow-github-runworkflow-t0ed50"
      targetId: "component-node-7z3mea"
      channel: "failed"
    - sourceId: "merge-merge-vckyv1"
      targetId: "github-runworkflow-deploy-10--w3pcg4"
      channel: "success"
    - sourceId: "github-runworkflow-deploy-10--w3pcg4"
      targetId: "wait-wait-for-the-changes-to-propagate-9f6hct"
      channel: "passed"
    - sourceId: "wait-wait-for-the-changes-to-propagate-9f6hct"
      targetId: "pagerduty-listincidents-check-if-there-are-open-issues-jl7aze"
      channel: "default"
    - sourceId: "pagerduty-listincidents-check-if-there-are-open-issues-jl7aze"
      targetId: "merge-merge-as9s0i"
      channel: "clear"
    - sourceId: "pagerduty-listincidents-check-if-there-are-open-issues-jl7aze"
      targetId: "merge-merge-as9s0i"
      channel: "low"
    - sourceId: "pagerduty-listincidents-check-if-there-are-open-issues-jl7aze"
      targetId: "merge-merge-as9s0i"
      channel: "high"
    - sourceId: "merge-merge-as9s0i"
      targetId: "github-runworkflow-github-runworkflow-0ae6uu"
      channel: "success"
