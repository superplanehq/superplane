version: v1.0
name: CI
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
auto_cancel:
  running:
    when: branch != 'main'
  queued:
    when: branch != 'main'

# Skip condition for documentation-only changes
.skip_on_docs_only: &skip_on_docs_only
  skip:
    when: "change_in('/', {default_branch: 'main', exclude: ['*.md', '**/*.md']}) == false"

blocks:
  - name: "\U0001F4DC License Check"
    dependencies: []
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: Licence Check
          commands:
            - make test.license.check
  - name: "\U0001F9EA QA"
    dependencies: []
    <<: *skip_on_docs_only
    task:
      env_vars:
        - name: DOCKER_BUILDKIT
          value: '1'
      prologue:
        commands:
          - checkout
          - make test.setup
          - make test.start
      jobs:
        - name: Lint
          commands:
            - make lint
        - name: Unit Tests
          commands:
            - make test
        - name: E2E Tests
          parallelism: 10
          commands:
            - make setup.playwright
            - make test.e2e.autoparallel INDEX=$SEMAPHORE_JOB_INDEX TOTAL=$SEMAPHORE_JOB_COUNT
        - name: 'Check: DB structure'
          commands:
            - make check.db.structure
            - make check.db.migrations
        - name: 'Check: Components Docs'
          commands:
            - make gen.components.docs
            - git diff --exit-code docs/components
        - name: 'Check: Go Format'
          commands:
            - make format.go.check
      epilogue:
        always:
          commands:
            - '[ -f junit-report.xml ] && test-results publish junit-report.xml'
  - name: "\U0001F528 Frontend Build"
    dependencies: []
    <<: *skip_on_docs_only
    task:
      prologue:
        commands:
          - checkout
          - sem-version node 20
      jobs:
        - name: Build Frontend
          commands:
            - 'cache restore node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum web_src/package-lock.json),node-modules-$SEMAPHORE_GIT_BRANCH,node-modules'
            - cd web_src
            - npm ci
            - cache store node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json) node_modules
            - npm run build
  - name: "\U0001F9EA Frontend Tests"
    dependencies:
      - "\U0001F528 Frontend Build"
    <<: *skip_on_docs_only
    task:
      prologue:
        commands:
          - checkout
          - sem-version node 20
      jobs:
        - name: UI Tests
          commands:
            - 'cache restore node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum web_src/package-lock.json),node-modules-$SEMAPHORE_GIT_BRANCH,node-modules'
            - cd web_src
            - npm ci
            - cache store node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json) node_modules
            - 'npm run test:run'
        - name: Format Check
          commands:
            - 'cache restore node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum web_src/package-lock.json),node-modules-$SEMAPHORE_GIT_BRANCH,node-modules'
            - cd web_src && npm ci && cd ..
            - make format.js.check
after_pipeline:
  task:
    jobs:
      - name: Submit Reports
        commands:
          - test-results gen-pipeline-report
