version: v1.0
name: Build Image
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
blocks:
  - name: "Build & Push"
    task:
      jobs:
        - name: "Build and push image"
          commands:
            - checkout
            - make image.auth
            - |
              if [[ "$SEMAPHORE_GIT_BRANCH" == "main" ]]; then
                echo "Building production image for main branch"
                make image.build BASE_URL=https://app.superplane.com
              else
                echo "Building staging image for branch: $SEMAPHORE_GIT_BRANCH"
                make image.build BASE_URL=https://superplane.sxmoon.com
              fi
            - make image.push
