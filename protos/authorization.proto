syntax = "proto3";

package Superplane.Authorization;

import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

option go_package = "github.com/superplanehq/superplane/pkg/protos/authorization";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "Superplane Authorization API";
    version: "1.0";
    description: "API for the Superplane Authorization service";
    contact: {
      name: "API Support";
      email: "support@superplane.com";
    };
  };
  schemes: HTTP;
  schemes: HTTPS;
  consumes: "application/json";
  produces: "application/json";
};

service Authorization {
  //
  // Endpoint for checking user permissions on any resource
  // Operation is synchronous and idempotent.
  //
  rpc CheckPermission(CheckPermissionRequest) returns (CheckPermissionResponse) {
    option (google.api.http) = {
      post: "/api/v1/authorization/check"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Check permission";
      description: "Checks if a user has permission to perform an action on a resource within a domain";
      tags: "Authorization";
    };
  }

  //
  // Endpoint for listing all user permissions within a domain
  // Operation is synchronous and idempotent.
  //
  rpc ListUserPermissions(ListUserPermissionsRequest) returns (ListUserPermissionsResponse) {
    option (google.api.http) = {
      get: "/api/v1/authorization/users/{user_id}/permissions"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List user permissions";
      description: "Returns all permissions a user has within a specific domain";
      tags: "Authorization";
    };
  }

  //
  // Endpoint for assigning a role to a user in an organization or canvas
  // Operation is synchronous and idempotent.
  //
  rpc AssignRole(AssignRoleRequest) returns (AssignRoleResponse) {
    option (google.api.http) = {
      post: "/api/v1/authorization/roles/assign"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Assign role";
      description: "Assigns a role to a user within an organization or canvas";
      tags: "Authorization";
    };
  }

  //
  // Endpoint for removing a role from a user in an organization or canvas
  // Operation is synchronous and idempotent.
  //
  rpc RemoveRole(RemoveRoleRequest) returns (RemoveRoleResponse) {
    option (google.api.http) = {
      post: "/api/v1/authorization/roles/remove"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Remove role";
      description: "Removes a role from a user within an organization or canvas";
      tags: "Authorization";
    };
  }

  //
  // Endpoint for listing available roles within a domain
  // Operation is synchronous and idempotent.
  //
  rpc ListRoles(ListRolesRequest) returns (ListRolesResponse) {
    option (google.api.http) = {
      get: "/api/v1/authorization/roles"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List roles";
      description: "Returns available roles for a specific domain type with their permissions and inheritance";
      tags: "Authorization";
    };
  }

  //
  // Endpoint for describing a specific role
  // Operation is synchronous and idempotent.
  //
  rpc DescribeRole(DescribeRoleRequest) returns (DescribeRoleResponse) {
    option (google.api.http) = {
      get: "/api/v1/authorization/roles/describe"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Describe role";
      description: "Returns detailed information about a specific role including permissions and inheritance";
      tags: "Authorization";
    };
  }

  //
  // Endpoint for listing accessible organizations for a user
  // Operation is synchronous and idempotent.
  //
  rpc ListAccessibleOrganizations(ListAccessibleOrganizationsRequest) returns (ListAccessibleOrganizationsResponse) {
    option (google.api.http) = {
      get: "/api/v1/authorization/organizations/accessible/{user_id}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List accessible organizations";
      description: "Returns a list of organizations the user has access to";
      tags: "Organization";
    };
  }

  //
  // Endpoint for listing accessible canvases for a user
  // Operation is synchronous and idempotent.
  //
  rpc ListAccessibleCanvases(ListAccessibleCanvasesRequest) returns (ListAccessibleCanvasesResponse) {
    option (google.api.http) = {
      get: "/api/v1/authorization/canvases/accessible/{user_id}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List accessible canvases";
      description: "Returns a list of canvases the user has access to";
      tags: "Canvas";
    };
  }

  //
  // Endpoint for getting user roles within a domain
  // Operation is synchronous and idempotent.
  //
  rpc GetUserRoles(GetUserRolesRequest) returns (GetUserRolesResponse) {
    option (google.api.http) = {
      get: "/api/v1/authorization/users/{user_id}/roles"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get user roles";
      description: "Returns the roles a user has within a specific domain";
      tags: "Authorization";
    };
  }

  //
  // Endpoint for creating an organization group
  // Operation is synchronous and idempotent.
  //
  rpc CreateGroup(CreateGroupRequest) returns (CreateGroupResponse) {
    option (google.api.http) = {
      post: "/api/v1/authorization/organizations/{org_id}/groups"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Create group";
      description: "Creates a new group within an organization with a specific role";
      tags: "Group";
    };
  }

  //
  // Endpoint for adding a user to an organization group
  // Operation is synchronous and idempotent.
  //
  rpc AddUserToGroup(AddUserToGroupRequest) returns (AddUserToGroupResponse) {
    option (google.api.http) = {
      post: "/api/v1/authorization/organizations/{org_id}/groups/{group_name}/users"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Add user to group";
      description: "Adds a user to an organization group";
      tags: "Group";
    };
  }

  //
  // Endpoint for removing a user from an organization group
  // Operation is synchronous and idempotent.
  //
  rpc RemoveUserFromGroup(RemoveUserFromGroupRequest) returns (RemoveUserFromGroupResponse) {
    option (google.api.http) = {
      delete: "/api/v1/authorization/organizations/{org_id}/groups/{group_name}/users/{user_id}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Remove user from group";
      description: "Removes a user from an organization group";
      tags: "Group";
    };
  }

  //
  // Endpoint for listing organization groups
  // Operation is synchronous and idempotent.
  //
  rpc ListOrganizationGroups(ListOrganizationGroupsRequest) returns (ListOrganizationGroupsResponse) {
    option (google.api.http) = {
      get: "/api/v1/authorization/organizations/{org_id}/groups"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List organization groups";
      description: "Returns a list of groups within an organization";
      tags: "Group";
    };
  }

  //
  // Endpoint for getting users in a specific group
  // Operation is synchronous and idempotent.
  //
  rpc GetGroupUsers(GetGroupUsersRequest) returns (GetGroupUsersResponse) {
    option (google.api.http) = {
      get: "/api/v1/authorization/organizations/{org_id}/groups/{group_name}/users"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get group users";
      description: "Returns users that belong to a specific group";
      tags: "Group";
    };
  }

  //
  // Endpoint for listing users with a specific role in an organization
  // Operation is synchronous and idempotent.
  //
  rpc ListOrganizationUsersForRole(ListOrganizationUsersForRoleRequest) returns (ListOrganizationUsersForRoleResponse) {
    option (google.api.http) = {
      get: "/api/v1/authorization/organizations/{org_id}/roles/{role}/users"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List organization users for role";
      description: "Returns users that have a specific role within an organization";
      tags: "Organization";
    };
  }

  //
  // Endpoint for listing users with a specific role in a canvas
  // Operation is synchronous and idempotent.
  //
  rpc ListCanvasUsersForRole(ListCanvasUsersForRoleRequest) returns (ListCanvasUsersForRoleResponse) {
    option (google.api.http) = {
      get: "/api/v1/authorization/canvases/{canvas_id}/roles/{role}/users"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List canvas users for role";
      description: "Returns users that have a specific role within a canvas";
      tags: "Canvas";
    };
  }
}

// Core permission check messages
message CheckPermissionRequest {
  string user_id = 1;
  DomainType domain_type = 2;
  string domain_id = 3;
  string resource = 4;
  string action = 5;
}

message CheckPermissionResponse {
  bool allowed = 1;
}

// User permissions listing messages
message ListUserPermissionsRequest {
  string user_id = 1;
  DomainType domain_type = 2;
  string domain_id = 3;
}

message ListUserPermissionsResponse {
  string user_id = 1;
  DomainType domain_type = 2;
  string domain_id = 3;
  repeated Permission permissions = 4;
}

// Role assignment messages
message AssignRoleRequest {
  string user_id = 1;
  RoleAssignment role_assignment = 2;
}

message AssignRoleResponse {}

message RemoveRoleRequest {
  string user_id = 1;
  RoleAssignment role_assignment = 2;
}

message RemoveRoleResponse {}

message RoleAssignment {
  DomainType domain_type = 1;
  string domain_id = 2;
  oneof role {
    OrganizationRole org_role = 3;
    CanvasRole canvas_role = 4;
  }
}

// Role discovery messages
message ListRolesRequest {
  DomainType domain_type = 1;
  string domain_id = 2;
}

message ListRolesResponse {
  repeated Role roles = 1;
}

message DescribeRoleRequest {
  DomainType domain_type = 1;
  string domain_id = 2;
  oneof role {
    OrganizationRole org_role = 3;
    CanvasRole canvas_role = 4;
  }
}

message DescribeRoleResponse {
  Role role = 1;
}

// Access listing messages
message ListAccessibleOrganizationsRequest {
  string user_id = 1;
}

message ListAccessibleOrganizationsResponse {
  repeated string org_ids = 1;
}

message ListAccessibleCanvasesRequest {
  string user_id = 1;
}

message ListAccessibleCanvasesResponse {
  repeated string canvas_ids = 1;
}

// User roles messages
message GetUserRolesRequest {
  string user_id = 1;
  DomainType domain_type = 2;
  string domain_id = 3;
}

message GetUserRolesResponse {
  string user_id = 1;
  DomainType domain_type = 2;
  string domain_id = 3;
  repeated UserRole roles = 4;
}

message UserRole {
  oneof role {
    OrganizationRole org_role = 1;
    CanvasRole canvas_role = 2;
  }
}

// Group management messages
message CreateGroupRequest {
  string org_id = 1;
  string group_name = 2;
  OrganizationRole role = 3;
}

message CreateGroupResponse {}

message AddUserToGroupRequest {
  string org_id = 1;
  string group_name = 2;
  string user_id = 3;
}

message AddUserToGroupResponse {}

message RemoveUserFromGroupRequest {
  string org_id = 1;
  string group_name = 2;
  string user_id = 3;
}

message RemoveUserFromGroupResponse {}

message ListOrganizationGroupsRequest {
  string org_id = 1;
}

message ListOrganizationGroupsResponse {
  repeated string groups = 1;
}

message GetGroupUsersRequest {
  string org_id = 1;
  string group_name = 2;
}

message GetGroupUsersResponse {
  repeated string user_ids = 1;
}

// Users for role messages
message ListOrganizationUsersForRoleRequest {
  string org_id = 1;
  OrganizationRole role = 2;
}

message ListOrganizationUsersForRoleResponse {
  repeated string user_ids = 1;
}

message ListCanvasUsersForRoleRequest {
  string canvas_id = 1;
  CanvasRole role = 2;
}

message ListCanvasUsersForRoleResponse {
  repeated string user_ids = 1;
}

// Core data structures
message Role {
  string name = 1;
  DomainType domain_type = 2;
  string description = 3;
  repeated Permission permissions = 4;
  Role inherited_role = 5;
  bool readonly = 6;
}

message Permission {
  string resource = 1;
  string action = 2;
  string description = 3;
  DomainType domain_type = 4;
}

// Enums
enum DomainType {
  DOMAIN_TYPE_UNSPECIFIED = 0;
  DOMAIN_TYPE_ORGANIZATION = 1;
  DOMAIN_TYPE_CANVAS = 2;
}

enum OrganizationRole {
  ORG_ROLE_UNSPECIFIED = 0;
  ORG_VIEWER = 1;
  ORG_ADMIN = 2;
  ORG_OWNER = 3;
}

enum CanvasRole {
  CANVAS_ROLE_UNSPECIFIED = 0;
  CANVAS_VIEWER = 1;
  CANVAS_ADMIN = 2;
  CANVAS_OWNER = 3;
}