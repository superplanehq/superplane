#!/usr/bin/env ruby

require 'date'

MIN_FIRST_COLUMN_WIDTH = 12

class GitLogs
  def self.load
    start_of_year = Date.new(Date.today().year, 1, 1)
    end_of_year = Date.new(Date.today().year, 12, 31)

    log_data = `git log origin/main --pretty=format:"%H,%an,%at,%s" --since=#{start_of_year.strftime('%Y-%m-%d')} --until=#{end_of_year.strftime('%Y-%m-%d')}`
    logs = log_data.split("\n").map { |line| GitLog.new(line) }

    GitLogs.new(logs)
  end

  def initialize(logs)
    @logs = logs
  end

  def group_by_week
    @weeks ||= @logs.group_by { |log| log.week }.map { |week, logs| Week.new(week, logs) }.sort_by { |week| week.week }
  end

  def authors
    @logs.map { |log| log.author }.uniq
  end

  def average_commits_per_week_by_author(author)
    @logs.select { |log| log.author == author }.count / group_by_week.count.to_f
  end

  def total_commits_for_author(author)
    @logs.select { |log| log.author == author }.count
  end

  def total_commits
    @logs.count
  end

  def total_feat
    @logs.select { |log| log.message.start_with?('feat:') }.count
  end

  def total_bugfixes
    @logs.select { |log| log.message.start_with?('fix:') }.count
  end

  def total_chore
    @logs.select { |log| log.message.start_with?('chore:') }.count
  end

  def total_docs
    @logs.select { |log| log.message.start_with?('docs:') }.count
  end
end

class GitLog
  attr_reader :commit_hash, :author, :timestamp, :message

  def initialize(raw_data)
    # Commit messages can contain commas, so only split the first 3 separators.
    @commit_hash, @author, @timestamp, @message = raw_data.strip.split(',', 4)
  end

  def week
    Date.strptime(@timestamp, '%s').strftime('%W')
  end
end

class Week
  attr_reader :week

  def initialize(week, logs)
    @week = week
    @logs = logs
  end

  def total_commits
    @logs.count
  end

  def total_feat
    @logs.select { |log| log.message.start_with?('feat:') }.count
  end

  def total_bugfixes
    @logs.select { |log| log.message.start_with?('fix:') }.count
  end

  def total_chore
    @logs.select { |log| log.message.start_with?('chore:') }.count
  end

  def total_docs
    @logs.select { |log| log.message.start_with?('docs:') }.count
  end

  def total_by_author(author)
    @logs.select { |log| log.author == author }.count
  end
end

class GitStats
  def initialize
    @logs = GitLogs.load()
    @weeks = @logs.group_by_week()
  end

  def draw_table
    puts separator()
    puts header()
    puts separator()

    authors_sorted_by_commits.each do |author|
      show_numbers(author, @weeks.map { |w| w.total_by_author(author) }, first_column_width)
    end

    puts separator()

    show_numbers("Throughput", @weeks.map { |w| w.total_commits }, first_column_width)
    show_numbers("Velocity", @weeks.map { |w| w.total_feat }, first_column_width)
    show_numbers("Fixes", @weeks.map { |w| w.total_bugfixes }, first_column_width)
    show_numbers("Chores", @weeks.map { |w| w.total_chore }, first_column_width)
    show_numbers("Docs", @weeks.map { |w| w.total_docs }, first_column_width)

    puts separator()
  end

  def authors_sorted_by_commits
    @logs.authors.sort do |a, b|
      diff = @logs.total_commits_for_author(b) <=> @logs.total_commits_for_author(a)
      diff.zero? ? a <=> b : diff
    end
  end

  def header
    @header ||= "WEEK".ljust(first_column_width + 1) + @weeks.map { |w| w.week.to_s.ljust(3) }.join(' ')
  end

  def separator
    @separator ||= "-" * header.length
  end

  def first_column_width
    @first_column_width ||= begin
      labels = ["WEEK", "Throughput", "Velocity", "Fixes", "Chores", "Docs"]
      max_label = labels.map(&:length).max || 0
      max_author = (@logs.authors.map(&:length).max || 0)
      [MIN_FIRST_COLUMN_WIDTH, max_label, max_author].max
    end
  end
end

def show_numbers(label, numbers, first_column_width)
  # Add one extra space so the first number never touches the label.
  str = label.ljust(first_column_width + 1)

  str += numbers.map do |n|
    if n == 0
      "\e[36m  .\e[0m"
    else
      n.to_s.rjust(3)
    end
  end.join(' ')

  str += "   = #{numbers.sum.to_s.rjust(4)}"
  nonzero_weeks = numbers.count { |n| n > 0 }
  avg = nonzero_weeks.zero? ? 0.0 : (numbers.sum.to_f / nonzero_weeks)
  str += " (avg: #{avg.round(1).to_s.rjust(4)})"

  puts str
end

stats = GitStats.new()
stats.draw_table()
